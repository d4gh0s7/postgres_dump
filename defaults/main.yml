---
# defaults file for postgres_dump

postgres_base_folder: /var/lib/pgsql

postgresql_backup_executor: postgres

postgresql_backup_owner: postgres

postgresql_dumpall_params:
  - --clean
  - --if-exists

# Flag to Yes in order to provision a temporay unprivileged user and run the pg_dumpall with it
# The user will be deleted immediateluy after
provision_temporary_user: Yes

provision_temporary_user_grant_privileges_commands:
  - GRANT SELECT ON ALL TABLES IN SCHEMA pg_catalog TO {{ postgresql_backup_executor }}
  - GRANT SELECT, USAGE ON ALL SEQUENCES IN SCHEMA pg_catalog TO {{ postgresql_backup_executor }}

# - name: Alter temporary user
#   command: psql --command="ALTER DEFAULT PRIVILEGES IN SCHEMA pg_catalog GRANT SELECT ON TABLES TO {{ random_username.stdout }};"

# - name: Alter temporary user
#   command: psql --command="ALTER DEFAULT PRIVILEGES IN SCHEMA pg_catalog GRANT SELECT, USAGE ON SEQUENCES TO {{ random_username.stdout }};"

provision_temporary_user_revoke_privileges_commands:
  - REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA pg_catalog FROM {{ postgresql_backup_executor }}
  - REVOKE ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA pg_catalog FROM {{ postgresql_backup_executor }}
...